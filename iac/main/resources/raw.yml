RawLayerBucket:
  Type: 'AWS::S3::Bucket'
  Properties:
    AccessControl: Private
    BucketName: !Sub ${Environment}-dap-raw-layer
    LoggingConfiguration:
      DestinationBucketName: !Ref GlobalLogBucket
      LogFilePrefix: dap-raw-layer/log
    PublicAccessBlockConfiguration:
      BlockPublicAcls: true
      BlockPublicPolicy: true
      IgnorePublicAcls: true
      RestrictPublicBuckets: true
    VersioningConfiguration:
      Status: Enabled
    LifecycleConfiguration:
      Rules:
        - ExpirationInDays: 365
          Status: Enabled
    NotificationConfiguration:
      LambdaConfigurations:
        - Event: s3:ObjectCreated:*
          Function: !GetAtt S3NotificationsLoggerLambda.Arn
        - Event: s3:ObjectRemoved:*
          Function: !GetAtt S3NotificationsLoggerLambda.Arn

RawLayerBucketPolicy:
  Type: AWS::S3::BucketPolicy
  Properties:
    Bucket: !Ref RawLayerBucket
    PolicyDocument:
      Version: 2012-10-17
      Statement:
        - Effect: Deny
          Action: 's3:*'
          Resource: !Sub ${RawLayerBucket.Arn}/*
          Principal: '*'
          Condition:
            Bool:
              aws:SecureTransport: false
        - Effect: Allow
          Action:
            - 's3:GetObject'
            - 's3:PutObject'
            - 's3:ListBucket'
          Resource:
            - !Sub ${RawLayerBucket.Arn}
            - !Sub ${RawLayerBucket.Arn}/*
          Principal:
            AWS: !Sub arn:aws:iam::${AWS::AccountId}:root

AuthAccountUserLoginCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: auth_account_user_login
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      S3Targets:
        - Path: !Sub 's3://${RawLayerBucket}/txma/AUTH_CHECK_USER_KNOWN_EMAIL/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/AUTH_LOG_IN_SUCCESS/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/AUTH_AUTH_CODE_ISSUED/'
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: UPDATE_IN_DATABASE
      DeleteBehavior: DELETE_FROM_DATABASE
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}, "Grouping": {"TableGroupingPolicy": "CombineCompatibleSchemas"}}'

AuthAccountCreationCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: auth_account_creation
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      S3Targets:
        - Path: !Sub 's3://${RawLayerBucket}/txma/AUTH_CHECK_USER_NO_ACCOUNT_WITH_EMAIL/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/AUTH_CREATE_ACCOUNT/'
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: UPDATE_IN_DATABASE
      DeleteBehavior: DELETE_FROM_DATABASE
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}, "Grouping": {"TableGroupingPolicy": "CombineCompatibleSchemas"}}'

AuthAccountManagementCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: auth_account_management
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      S3Targets:
        - Path: !Sub 's3://${RawLayerBucket}/txma/AUTH_PASSWORD_RESET_SUCCESSFUL/'
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: UPDATE_IN_DATABASE
      DeleteBehavior: DELETE_FROM_DATABASE
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}, "Grouping": {"TableGroupingPolicy": "CombineCompatibleSchemas"}}'

AuthAccountMfaCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: auth_account_mfa
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      S3Targets:
        - Path: !Sub 's3://${RawLayerBucket}/txma/AUTH_CODE_VERIFIED/'
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: UPDATE_IN_DATABASE
      DeleteBehavior: DELETE_FROM_DATABASE
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}, "Grouping": {"TableGroupingPolicy": "CombineCompatibleSchemas"}}'

AuthOrchestrationCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: auth_orchestration
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      S3Targets:
        - Path: !Sub 's3://${RawLayerBucket}/txma/AUTH_AUTHORISATION_INITIATED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/AUTH_AUTHORISATION_REQUEST_ERROR/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/AUTH_AUTHORISATION_REQUEST_RECEIVED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/AUTH_IPV_AUTHORISATION_REQUESTED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/AUTH_DOC_APP_AUTHORISATION_REQUESTED/'
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: UPDATE_IN_DATABASE
      DeleteBehavior: DELETE_FROM_DATABASE
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}, "Grouping": {"TableGroupingPolicy": "CombineCompatibleSchemas"}}'

DcmawCriCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: dcmaw_cri
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      S3Targets:
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_APP_END'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_APP_HANDOFF_START'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_APP_START'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_CRI_START'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_CRI_VC_ISSUED'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_DRIVING_LICENCE_SELECTED'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_PASSPORT_SELECTED'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_WEB_END/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_BRP_SELECTED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_SESSION_RECOVERED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_ABORT_APP/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_ABORT_WEB/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_CRI_4XXERROR/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_CRI_5XXERROR/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_CRI_END/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_HYBRID_BILLING_STARTED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_IPROOV_BILLING_STARTED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_MISSING_CONTEXT_AFTER_ABORT/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_MISSING_CONTEXT_AFTER_COMPLETION/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_READID_NFC_BILLING_STARTED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_REDIRECT_ABORT/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/DCMAW_REDIRECT_SUCCESS/'
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: UPDATE_IN_DATABASE
      DeleteBehavior: DELETE_FROM_DATABASE
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}, "Grouping": {"TableGroupingPolicy": "CombineCompatibleSchemas"}}'

IpvCriAddressCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: ipv_cri_address
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      S3Targets:
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_ADDRESS_CRI_START/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_ADDRESS_CRI_VC_ISSUED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_ADDRESS_CRI_END/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_ADDRESS_CRI_REQUEST_SENT/'
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: UPDATE_IN_DATABASE
      DeleteBehavior: DELETE_FROM_DATABASE
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}, "Grouping": {"TableGroupingPolicy": "CombineCompatibleSchemas"}}'

IpvCriDrivingLicenseCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: ipv_cri_driving_license
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      S3Targets:
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_DL_CRI_START/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_DL_CRI_VC_ISSUED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_DL_CRI_END/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_DL_CRI_REQUEST_SENT/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_DL_CRI_RESPONSE_RECEIVED/'
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: UPDATE_IN_DATABASE
      DeleteBehavior: DELETE_FROM_DATABASE
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}, "Grouping": {"TableGroupingPolicy": "CombineCompatibleSchemas"}}'

IpvCriFraudCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: ipv_cri_fraud
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      S3Targets:
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_FRAUD_CRI_START/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_FRAUD_CRI_VC_ISSUED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_FRAUD_CRI_REQUEST_SENT/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_FRAUD_CRI_RESPONSE_RECEIVED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_FRAUD_CRI_THIRD_PARTY_REQUEST_ENDED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_FRAUD_CRI_END/'
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: UPDATE_IN_DATABASE
      DeleteBehavior: DELETE_FROM_DATABASE
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}, "Grouping": {"TableGroupingPolicy": "CombineCompatibleSchemas"}}'

IpvCriKbvCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: ipv_cri_kbv
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      S3Targets:
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_KBV_CRI_START/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_KBV_CRI_VC_ISSUED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_KBV_CRI_END/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_KBV_CRI_REQUEST_SENT/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_KBV_CRI_RESPONSE_RECEIVED/'
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: UPDATE_IN_DATABASE
      DeleteBehavior: DELETE_FROM_DATABASE
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}, "Grouping": {"TableGroupingPolicy": "CombineCompatibleSchemas"}}'

IpvCriPassportCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: ipv_cri_passport
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      S3Targets:
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_PASSPORT_CRI_START/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_PASSPORT_CRI_VC_ISSUED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_PASSPORT_CRI_END/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_PASSPORT_CRI_REQUEST_SENT/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/IPV_PASSPORT_CRI_RESPONSE_RECEIVED/'
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: UPDATE_IN_DATABASE
      DeleteBehavior: DELETE_FROM_DATABASE
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}, "Grouping": {"TableGroupingPolicy": "CombineCompatibleSchemas"}}'

IpvCriCicCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: ipv_cri_cic
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      S3Targets:
        - Path: !Sub 's3://${RawLayerBucket}/txma/CIC_CRI_AUTH_CODE_ISSUED/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/CIC_CRI_START/'
        - Path: !Sub 's3://${RawLayerBucket}/txma/CIC_CRI_VC_ISSUED/'
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: UPDATE_IN_DATABASE
      DeleteBehavior: DELETE_FROM_DATABASE
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}, "Grouping": {"TableGroupingPolicy": "CombineCompatibleSchemas"}}'

FtofCriVcIssuedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: f2f_cri_vc_issued
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: client_id, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<configVersion:string>' }
          - {
              Name: extensions,
              Type: 'struct<previous_govuk_signin_journey_id:string,evidence:array<struct<checkDetails:array<struct<biometricVerificationProcessLevel:int,checkMethod:string,photoVerificationProcessLevel:int>>,strengthScore:int,type:string,validityScore:int,verificationScore:int>>>',
            }
          - {
              Name: restricted,
              Type: 'struct<passport:array<struct<documentType:string,issuingCountry:string>>,residencePermit:array<struct<documentType:string,issuingCountry:string>>,drivingPermit:array<struct<documentType:string,issuingCountry:string>>,idCard:array<struct<documentType:string,issuingCountry:string>>>',
            }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/F2F_CRI_VC_ISSUED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

FtofCriAuthCodeIssuedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: f2f_cri_auth_code_issued
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: client_id, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<configVersion:string>' }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/F2F_CRI_AUTH_CODE_ISSUED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

FtofCriStartGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: f2f_cri_start
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: client_id, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<configVersion:string>' }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/F2F_CRI_START/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

FtofYotiPdfEmailedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: f2f_yoti_pdf_emailed
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: client_id, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<configVersion:string>' }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/F2F_YOTI_PDF_EMAILED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

FtofYotiStartGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: f2f_yoti_start
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: client_id, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<configVersion:string>' }
          - {
              Name: restricted,
              Type: 'struct<passport:array<struct<documentType:string,issuingCountry:string>>,residencePermit:array<struct<documentType:string,issuingCountry:string>>,drivingPermit:array<struct<documentType:string,issuingCountry:string>>,idCard:array<struct<documentType:string,issuingCountry:string>>>',
            }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/F2F_YOTI_START/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

FtofIprResultNotificationEmailedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipr_result_notification_emailed
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<configVersion:string>' }
          - { Name: extensions, Type: 'struct<previous_govuk_signin_journey_id:string>' }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPR_RESULT_NOTIFICATION_EMAILED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

FtofIprUserRedirectedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipr_user_redirected
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<configVersion:string>' }
          - { Name: extensions, Type: 'struct<previous_govuk_signin_journey_id:string>' }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPR_USER_REDIRECTED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

FtofIpvCriVcConsumedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_f2f_cri_vc_consumed
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<configVersion:string>' }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_F2F_CRI_VC_CONSUMED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

FtofIpvCriVcReceivedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_f2f_cri_vc_received
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<configVersion:string>' }
          - {
              Name: extensions,
              Type: 'struct<iss:string,successful:boolean,evidence:array<struct<checkDetails:array<struct<biometricVerificationProcessLevel:int,checkMethod:string,photoVerificationProcessLevel:int>>,failedCheckDetails:array<struct<biometricVerificationProcessLevel:int,checkMethod:string>>,strengthScore:int,type:string,validityScore:int,verificationScore:int>>>',
            }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_F2F_CRI_VC_RECEIVED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

FtofYotiResponseReceivedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: f2f_yoti_response_received
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: client_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<configVersion:string>' }
          - { Name: extensions, Type: 'struct<previous_govuk_signin_journey_id:string>' }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/F2F_YOTI_RESPONSE_RECEIVED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvCriFtofCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: ipv_cri_f2f
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      CatalogTargets:
        - DatabaseName: !Ref RawGlueDatabase
          Tables:
            - !Ref FtofCriVcIssuedGlueTable
            - !Ref FtofCriAuthCodeIssuedGlueTable
            - !Ref FtofCriStartGlueTable
            - !Ref FtofYotiPdfEmailedGlueTable
            - !Ref FtofYotiStartGlueTable
            - !Ref FtofIprResultNotificationEmailedGlueTable
            - !Ref FtofIprUserRedirectedGlueTable
            - !Ref FtofIpvCriVcConsumedGlueTable
            - !Ref FtofIpvCriVcReceivedGlueTable
            - !Ref FtofYotiResponseReceivedGlueTable
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: LOG
      DeleteBehavior: LOG
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}}'

IpvIdentityIssuedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_identity_issued
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: client_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<configVersion:string>' }
          - { Name: extensions, Type: 'struct<hasMitigations:boolean,levelOfConfidence:string,ciFail:boolean>' }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_IDENTITY_ISSUED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvIdentityReuseCompleteGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_identity_reuse_complete
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: client_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<obfuscated:boolean,config_version:string,configVersion:string>' }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_IDENTITY_REUSE_COMPLETE/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvIdentityReuseResetGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_identity_reuse_reset
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: client_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<obfuscated:boolean,config_version:string,configVersion:string>' }
          - { Name: reingestcount, Type: int }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_IDENTITY_REUSE_RESET/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvJourneyEndGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_journey_end
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: client_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<obfuscated:boolean,config_version:string,configVersion:string>' }
          - { Name: reingestcount, Type: int }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_JOURNEY_END/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvJourneyStartGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_journey_start
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: client_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<obfuscated:boolean,config_version:string,configVersion:string>' }
          - { Name: reingestcount, Type: int }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_JOURNEY_START/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvMitigationStartGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_mitigation_start
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_MITIGATION_START/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvSpotResponseApprovedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_spot_response_approved
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: client_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<obfuscated:boolean,config_version:string,configVersion:string>' }
          - { Name: reingestcount, Type: int }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_SPOT_RESPONSE_APPROVED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvSpotResponseRejectedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_spot_response_rejected
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: client_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - { Name: txma, Type: 'struct<obfuscated:boolean,config_version:string,configVersion:string>' }
          - { Name: extensions, Type: 'struct<rejectionReason:string,reason:string>' }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_SPOT_RESPONSE_REJECTED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvCriAuthResponseReceivedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_cri_auth_response_received
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_CRI_AUTH_RESPONSE_RECEIVED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvDeleteUserDataGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_delete_user_data
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_DELETE_USER_DATA/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvRedirectToCriGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_redirect_to_cri
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_REDIRECT_TO_CRI/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvSpotRequestReceivedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_spot_request_received
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_SPOT_REQUEST_RECEIVED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvSpotRequestValidationFailureGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_spot_request_validation_failure
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_SPOT_REQUEST_VALIDATION_FAILURE/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvCoreCriResourceRetrievedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_core_cri_resource_retrieved
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_CORE_CRI_RESOURCE_RETRIEVED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvGpg45ProfileMatchedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_gpg45_profile_matched
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - {
              Name: extensions,
              Type: 'struct<gpg45Scores:struct<evidences:array<struct<strength:int,validity:int>>,activity:int,fraud:int,verification:int>>',
            }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_GPG45_PROFILE_MATCHED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvVcReceivedGlueTable:
  Type: AWS::Glue::Table
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseName: !Ref RawGlueDatabase
    TableInput:
      Name: ipv_vc_received
      TableType: EXTERNAL_TABLE
      PartitionKeys:
        - { Name: year, Type: string }
        - { Name: month, Type: string }
        - { Name: day, Type: string }
      StorageDescriptor:
        Columns:
          - { Name: event_id, Type: string }
          - { Name: event_name, Type: string }
          - { Name: component_id, Type: string }
          - { Name: user, Type: 'struct<govuk_signin_journey_id:string,user_id:string>' }
          - { Name: timestamp, Type: int }
          - { Name: timestamp_formatted, Type: string }
          - {
              Name: extensions,
              Type: 'struct<age:int,isUkIssued:boolean,iss:string,successful:boolean,evidence:array<struct<checkDetails:array<struct<checkMethod:string,kbvResponseMode:string,kbvQuality:int,biometricVerificationProcessLevel:int>>,failedCheckDetails:array<struct<checkMethod:string,kbvResponseMode:string>>,activityHistoryScore:int,identityFraudScore:int,strengthScore:int,type:string,validityScore:int,verificationScore:int>>>',
            }
        InputFormat: org.apache.hadoop.mapred.TextInputFormat
        Location: !Sub s3://${RawLayerBucket}/txma/IPV_VC_RECEIVED/
        OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
        SerdeInfo:
          Parameters:
            serialiazation.format: 1
          SerializationLibrary: org.openx.data.jsonserde.JsonSerDe

IpvJourneyCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: ipv_journey
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      CatalogTargets:
        - DatabaseName: !Ref RawGlueDatabase
          Tables:
            - !Ref IpvIdentityIssuedGlueTable
            - !Ref IpvIdentityReuseCompleteGlueTable
            - !Ref IpvIdentityReuseResetGlueTable
            - !Ref IpvJourneyEndGlueTable
            - !Ref IpvJourneyStartGlueTable
            - !Ref IpvSpotResponseApprovedGlueTable
            - !Ref IpvSpotResponseRejectedGlueTable
            - !Ref IpvCriAuthResponseReceivedGlueTable
            - !Ref IpvDeleteUserDataGlueTable
            - !Ref IpvRedirectToCriGlueTable
            - !Ref IpvSpotRequestReceivedGlueTable
            - !Ref IpvSpotRequestValidationFailureGlueTable
            - !Ref IpvCoreCriResourceRetrievedGlueTable
            - !Ref IpvGpg45ProfileMatchedGlueTable
            - !Ref IpvVcReceivedGlueTable
            - !Ref IpvMitigationStartGlueTable
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: LOG
      DeleteBehavior: LOG
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}}'

RawGlueCrawlerRole:
  Type: AWS::IAM::Role
  Properties:
    RoleName: !Sub ${Environment}-raw-glue-crawler-role
    AssumeRolePolicyDocument:
      Version: '2012-10-17'
      Statement:
        - Effect: Allow
          Principal:
            Service: [glue.amazonaws.com]
          Action: ['sts:AssumeRole']
    ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
    Path: /
    Policies:
      - PolicyName: !Sub ${Environment}-raw-glue-crawler-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - 'glue:GetConnection'
                - 'glue:GetCrawler'
                - 'glue:CreateTable'
                - 'glue:UpdateCrawler'
                - 'glue:CreatePartition'
                - 'glue:BatchCreatePartition'
              Resource: '*'
            - Effect: Allow
              Action:
                - 's3:GetObject'
                - 's3:PutObject'
                - 's3:ListObject'
              Resource:
                - !Sub 'arn:aws:s3:::${RawLayerBucket}'
                - !Sub 'arn:aws:s3:::${RawLayerBucket}/*'
            - Effect: Allow
              Action: 'logs:AssociateKmsKey'
              Resource: 'arn:aws:logs:*:*:/aws-glue/*'

RawGlueDatabase:
  Type: AWS::Glue::Database
  Properties:
    CatalogId: !Sub ${AWS::AccountId}
    DatabaseInput:
      Name: !Sub ${Environment}-${RawGlueDatabaseName}

RawLayerSingleTableCrawler:
  Type: AWS::Glue::Crawler
  Properties:
    Name: txma_raw_layer_events_schema_combined
    Role: !GetAtt RawGlueCrawlerRole.Arn
    Targets:
      S3Targets:
        - Path: !Sub 's3://${RawLayerBucket}/txma/'
    DatabaseName: !Ref RawGlueDatabase
    CrawlerSecurityConfiguration: !Ref GlueSecurityConfig
    RecrawlPolicy:
      RecrawlBehavior: CRAWL_EVERYTHING
    SchemaChangePolicy:
      UpdateBehavior: UPDATE_IN_DATABASE
      DeleteBehavior: DELETE_FROM_DATABASE
    Configuration: '{"Version":1,"CrawlerOutput":{"Partitions":{"AddOrUpdateBehavior":"InheritFromTable"}}, "Grouping": {"TableGroupingPolicy": "CombineCompatibleSchemas"}}'
